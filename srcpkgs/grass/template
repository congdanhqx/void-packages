# Template file for 'grass'
pkgname=grass
version=7.8.5
revision=1
build_style=gnu-configure
build_helper=cmake-wxWidgets-gtk3
configure_args="--prefix=/usr/libexec
 --with-nls --with-bzlib --with-pthread --with-python
 --with-wxwidgets=$WX_CONFIG
 $(vopt_with geos) $(vopt_with mysql) $(vopt_with postgres)"
hostmakedepends="flex libgdal-tools pkg-config python3-numpy python3-six tar
 gettext"
makedepends="proj-devel tiff-devel libgdal-devel sqlite-devel
 fftw-devel cairo-devel glu-devel wxPython4
 libzstd-devel bzip2-devel $(vopt_if geos geos-devel)
 $(vopt_if mysql libmariadbclient-devel)
 $(vopt_if postgres postgresql-libs-devel)"
depends="python3-numpy wxPython4"
short_desc="Geographic Resources Analysis Support System"
maintainer="Nyx70 <n.y.x@bluewin.ch>"
license="GPL-2.0-or-later"
homepage="https://grass.osgeo.org/"
distfiles="https://github.com/OSGeo/grass/archive/${version}.tar.gz"
checksum=a359bb665524ecccb643335d70f5436b1c84ffb6a0e428b78dffebacd983ff37
nocross="tries to execute target binaries"
CPPFLAGS="  -I${XBPS_CROSS_BASE}/usr/include/freetype2"
CPPFLAGS+=" -I${XBPS_CROSS_BASE}/usr/include/mysql"

build_options="geos mysql postgres"
build_options_default="geos postgres"

do_install() {
	local _file
	local _libexec=/usr/libexec/grass-$version
	make INST_DIR=${DESTDIR}${_libexec} \
		UNIX_BIN=${DESTDIR}/usr/bin \
		install
	for _file in AUTHORS CHANGES CITING COPYING GPL.TXT INSTALL \
		REQUIREMENTS.html config.status \
		contributors.csv contributors_extra.csv \
		demolocation/PERMANENT/.tmp/ \
		translation_status.json translators.csv
	do
		rm -rf ${DESTDIR}${_libexec}/${_file}
	done
	rm -rf ${DESTDIR}/usr/lib
	mv ${DESTDIR}${_libexec}/lib ${DESTDIR}/usr
	vsed -i ${DESTDIR}/usr/bin/grass* -e "s:${DESTDIR}::"
	vmkdir usr/share
	mv ${DESTDIR}${_libexec}/locale ${DESTDIR}/usr/share
	mv ${DESTDIR}${_libexec}/docs/man ${DESTDIR}/usr/share
}

grass-devel_package() {
	short_desc+=" - development files"
	depends="${sourcepkg}>=${version}_${revision}"
	pkg_install() {
		local _file
		vmove usr/libexec/grass-$version/include
		vmove usr/libexec/grass-$version/tools
		vmove "usr/lib/*.a"
		for _file in $DESTDIR/usr/lib/libgrass_*.so; do
			case "$_file" in
				*${version%.*}.so) ;;
				*) mv "$_file" "${PKGDESTDIR}/usr/lib" ;;
			esac
		done
		vinstall grass.pc 644 usr/share/pkgconfig
	}
}
