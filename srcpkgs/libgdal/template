# Template file for 'libgdal'
pkgname=libgdal
version=3.2.1
revision=1
wrksrc="gdal-${version}"
build_style=gnu-configure
configure_args="--with-expat=yes --with-liblzma=yes --with-opencl=yes
 --with-podofo=yes --with-spatialite=yes --with-sqlite3=yes
 --with-webp=yes --with-zstd=yes --with-libjson-c=${XBPS_CROSS_BASE}/usr
 $(vopt_if libkml) $(vopt_with postgresql pg)"
hostmakedepends="gettext pkg-config python3-numpy swig"
makedepends="boost-devel expat-devel freexl-devel geos-devel jasper-devel
 json-c-devel libcurl-devel libopenexr-devel libopenjpeg2-devel
 libpodofo-devel libqhull-devel libspatialite-devel libwebp-devel
 libxml2-devel libzstd-devel netcdf-devel ocl-icd-devel opencl-headers
 pcre2-devel proj-devel python3-devel sqlite-devel
 $(vopt_if libkml libkml-devel) $(vopt_if postgresql postgresql-libs-devel)"
short_desc="Geospatial Data Abstraction Library"
maintainer="Jürgen Buchmüller <pullmoll@t-online.de>"
license="MIT"
homepage="http://www.gdal.org/"
distfiles="https://github.com/OSGeo/gdal/releases/download/v${version}/gdal-${version}.tar.gz"
checksum=43d40ba940e3927e38f9e98062ff62f9fa993ceade82f26f16fab7e73edb572e
# -tools must be the last subpackages
subpackages="python3-gdal libgdal-devel libgdal-tools"

build_options="libkml postgresql"
build_options_default="libkml"
CFLAGS="-I${XBPS_CROSS_BASE}/${py3_inc}"
CXXFLAGS="$CFLAGS"
LDFLAGS="-L${XBPS_CROSS_BASE}/${py3_lib}"

_python_env() {
	local f
	export PYPREFIX="${XBPS_CROSS_BASE}"
	export LDSHARED="${CXX} -shared ${LDFLAGS}"
	export PYTHONPATH=${XBPS_CROSS_BASE}/${py3_lib}
	for f in ${XBPS_CROSS_BASE}/${py3_lib}/_sysconfigdata_*; do
		f=${f##*/}
		export _PYTHON_SYSCONFIGDATA_NAME=${f%.py}
	done
}

post_build() {
	cd ${wrksrc}/swig/python
	_python_env
	python3 setup.py build
	cd ${wrksrc}
}

post_install() {
	vinstall gdal.pc 644 usr/lib/pkgconfig
	vlicense LICENSE.TXT
	cd ${wrksrc}/swig/python
	_python_env
	python3 setup.py install --prefix=/usr --root=${DESTDIR}
	cd ${wrksrc}
}

libgdal-tools_package() {
	depends="${sourcepkg}>=${version}_${revision}"
	short_desc+=" - tools"
	pkg_install() {
		vmove usr/bin
	}
}

libgdal-devel_package() {
	depends="${sourcepkg}>=${version}_${revision}"
	short_desc+=" - development files"
	pkg_install() {
		vmove usr/bin/gdal-config
		vmove usr/include
		vmove usr/lib/pkgconfig
		vmove usr/lib/*.a
		vmove usr/lib/*.so
	}
}

python3-gdal_package() {
	depends="${sourcepkg}>=${version}_${revision}"
	short_desc+=" - Python3 bindings"
	pkg_install() {
		vmove "usr/bin/*.py"
		vmove "$py3_lib"
		vmkdir usr/share/examples
		cp -R swig/python/samples ${PKGDESTDIR}/usr/share/examples/${pkgname}
	}
}
